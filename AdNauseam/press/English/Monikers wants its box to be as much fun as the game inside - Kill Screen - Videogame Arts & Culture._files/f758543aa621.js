var KS=(function($){var self={},$html=$('html'),$overlay=$('.body-overlay'),$wrapper=$('.site-wrapper'),$header=$('.site-header'),$sidebar=$('.site-sidebar'),isHome=$wrapper.hasClass('home'),isArticle=$('.article-wrapper').length,isPlaylist=$('.playlist-sidebar').length,$homeLargeAd=$('.home .advert-wrapper.s300x600');self.shouldPositionHomeLargeAd=false;self.shouldPositionSidebar=false;self.init=function(){self.bindUI();self.setupAds();self.setupSecondaryNav();self.setupArticleSliders();self.setupNewsReviewSlider($('.news-review-slider'));self.setupMediaQueries();self.setupArticle();self.setupLoadArticles();self.setupPlaylist();};self.bindUI=function(){$header.waypoint('sticky');$overlay.on('click',function(e){$html.removeClass('menu-opened search-opened sidebar-opened');$overlay.trigger('overlay.update');});$overlay.on('overlay.update',function(){if($html.hasClass('menu-opened')||$html.hasClass('sidebar-opened')){$overlay.fadeIn(200);}
else{$overlay.fadeOut(200);if(isPlaylist)updateHash('');}});$('.menu-toggle').on('click',function(e){e.preventDefault();$html.toggleClass('menu-opened');$overlay.trigger('overlay.update');});$('.site-wrapper').on('click','.article-sidebar-toggle',function(e){$html.toggleClass('sidebar-opened');$overlay.trigger('overlay.update');});$('.search-toggle').on('click',function(e){var $input=$('.site-header form input');if($html.hasClass('search-opened')&&$input.val()===''){e.preventDefault();$input.focus();}
else if(!$html.hasClass('search-opened')){e.preventDefault();$html.addClass('search-opened');$input.focus();}});$('.search-form input').on('blur',function(e){e.preventDefault();if(e.relatedTarget===null&&$html.hasClass('search-opened')&&$(this).val()===''){$html.removeClass('search-opened');}});$('.nav-wrapper').on('click',function(e){if(!$html.hasClass('search-opened')&&$(this).prop('class')==$(e.target).prop('class')){e.preventDefault();$html.toggleClass('search-opened').find('.site-header form input').focus();}});$(document).keyup(function(e){if(e.keyCode==27)$html.removeClass('search-opened menu-opened');});if(isHome)$(window).on('resize',$.throttle(250,self.positionHomeLargeAd));if($sidebar.length)$(window).on('resize',$.throttle(250,self.positionSidebar));};self.setupAds=function(){$.dfp({dfpID:window.KSDFPID,enableSingleRequest:false});};self.setupSecondaryNav=function(){$('.secondary-nav').waypoint('sticky',{offset:$header.height()});$('.secondary-nav').on('click','a',function(e){e.preventDefault();self.scrollToAnchor($(this).attr('href'),true);});self.scrollToAnchor(window.location.hash,false);if($wrapper.hasClass('page-about')){$('.about-links').on('click','a',function(e){e.preventDefault();self.scrollToAnchor($(this).attr('href'),true);});}}
self.scrollToAnchor=function(href,animate){href=typeof(href)=='string'?href:$(this).attr('href');href=href.substring(href.indexOf('#'));if(href.indexOf('#')==0){var $target=$(href);if($target.length){var scrollOpts={offset:-80};if(animate)scrollOpts.duration=500;$.scrollTo(href,scrollOpts);}}};self.setupNewsReviewSlider=function($slider){if(!$slider.length||$slider.find('.slides li').length<2)return;$slider.flexslider({animation:'slide',controlNav:false,slideshow:false});};self.positionSidebar=function(){if(!self.shouldPositionSidebar)return;var $currentArticle=$('.article-wrapper.article.current');if($currentArticle.length){var contentHeight=$currentArticle.outerHeight();$currentArticle.find('.site-sidebar').height(contentHeight);}
else{var contentHeight=$sidebar.find('.sidebar-content').outerHeight();var targetHeight=$wrapper.outerHeight()
var marginHeight=parseInt($wrapper.css('margin-bottom'));if(contentHeight>targetHeight){$wrapper.height(contentHeight+marginHeight);targetHeight=contentHeight;}
$sidebar.height(targetHeight+marginHeight);}};self.setupMediaQueries=function(){enquire.register("screen and (max-width: 1024px)",{match:function(){self.updateArticleSliders();},unmatch:function(){self.updateArticleSliders();}});enquire.register("screen and (min-width: 1024px)",{match:function(){self.shouldPositionSidebar=true;if($sidebar.length){setTimeout(function(){self.positionSidebar();$sidebar.removeClass('visible');},2000);}},unmatch:function(){self.shouldPositionSidebar=false;$sidebar.css('height','auto');$wrapper.css('height','auto');if($sidebar.length)$sidebar.addClass('visible')}});enquire.register("screen and (max-width: 748px)",{match:function(){self.updateArticleSliders();$html.removeClass('search-opened menu-opened');},unmatch:function(){self.updateArticleSliders();$html.removeClass('search-opened menu-opened');}});enquire.register("screen and (min-width: 748px)",{match:function(){self.shouldPositionHomeLargeAd=true;},unmatch:function(){self.shouldPositionHomeLargeAd=false;$homeLargeAd.css('height','auto');}});enquire.register("screen and (min-width: 530px)",{match:function(){$('.antiscroll-wrap').antiscroll({autoHide:false});}});};self.getArticleSliderOpts=function(){var opts={},width=$(window).width();opts.animation='slide';opts.controlNav=false;opts.directionNav=false;opts.slideshow=false;opts.start=function(slider){slider.css('visibility','visible')
slider.find('.flex-nav').on('click',function(e){e.preventDefault();slider.flexAnimate(slider.getTarget($(this).data('dir')));});self.toggleArticleSliderArrows(slider);};opts.after=function(slider){var $prev=slider.find('.flex-prev'),$next=slider.find('.flex-next');if(slider.atEnd){if(slider.currentSlide){$prev.show();$next.hide();}
else{$prev.hide();$next.show();}}
else{$prev.show();$next.show();}};if(width>=1024){opts.minItems=3;opts.maxItems=3;opts.itemWidth=480}
else if(width>=748){opts.minItems=2;opts.maxItems=2;opts.itemWidth=385}
return opts;};self.setupArticleSliders=function(){var $sliders=$('.article-slider');if(!$sliders.length)return;$sliders.flexslider(self.getArticleSliderOpts());};self.updateArticleSliders=function(){var $sliders=$('.article-slider');if(!$sliders.length)return;$('.flex-viewport:empty').remove();$sliders.each(function(){var $slider=$(this);if($slider){$slider.css('visibility','hidden');$slider.flexslider('destroy');self.toggleArticleSliderArrows($slider);}});$sliders.flexslider(self.getArticleSliderOpts());};self.toggleArticleSliderArrows=function($slider){var numSlides=$slider.find('.slide').length,$prev=$slider.find('.flex-prev'),$next=$slider.find('.flex-next'),width=$(window).width();if(width>=1024&&numSlides<4){$next.hide();$prev.hide();}
else if(width>=748&&numSlides<3){$next.hide();$prev.hide();}
else{$next.show();}};self.positionHomeLargeAd=function(){if(!self.shouldPositionHomeLargeAd)return;var $targetArticleBlock=$('.article-blocks.bottom .article-block').first();var targetHeight=parseInt(($targetArticleBlock.height()*2)+parseInt($targetArticleBlock.css('padding-bottom')));$homeLargeAd.css('height',targetHeight);};self.setupArticle=function(){if(!isArticle)return;var $currentArticle=$('.article-wrapper').first().addClass('current');self.setupShareWaypoint($currentArticle);$currentArticle.find('.article-content').fitVids();if($currentArticle.hasClass('infinite-scroll')){self.setupArticleWaypoint($currentArticle);if($('html').hasClass('history')){$('.site-wrapper').waypoint('infinite',{items:'.article-wrapper, .article-wrapper + .related-articles',offset:'bottom-in-view',onAfterPageLoad:function(){$loadedArticle=$('.article-wrapper').last().toggleClass('loaded-article');$loadedArticle.find('.in-between-advert .adunit').trigger('infiniteloaded');self.setupArticleWaypoint($loadedArticle);self.setupShareWaypoint($loadedArticle);$loadedArticle.find('.article-content').fitVids();var $loadedSidebar=$loadedArticle.find('.site-sidebar');if($loadedSidebar.length){setTimeout(function(){$loadedSidebar.removeClass('visible');self.positionSidebar();},2000);}}});}}};self.setupShareWaypoint=function($article){var $shares=$article.find('.shares-comment');$article.waypoint(function(dir){if(dir==='down'){$shares.addClass('stuck');}
else{$shares.removeClass('stuck');}},{offset:-200}).waypoint(function(dir){if(dir==='up'){$shares.addClass('stuck');}
else{$shares.removeClass('stuck');}},{offset:'bottom-in-view'});};self.setupArticleWaypoint=function($article){$article.waypoint(function(dir){if(dir==='up'){if(!$(this).hasClass('current'))self.setCurrentArticle($(this));}},{offset:'bottom-in-view'}).waypoint(function(dir){if(dir==='down'){if(!$(this).hasClass('current'))self.setCurrentArticle($(this));}},{offset:0});};self.setCurrentArticle=function($article){$('.article-wrapper.current').removeClass('current');$article.addClass('current');History.pushState(null,$article.data('title'),$article.data('url'));stButtons.locateElements();self.setupFacebookComments();self.setupNewsReviewSlider($article.find('.news-review-slider'));$(window).resize();};self.setupFacebookComments=function(){var $comments=$('.fb-comments');$comments.data('href',document.location.href);FB.XFBML.parse();};self.updateShareCount=function(){var $article=$('.article-wrapper.current'),$shareBox=$article.find('.shares-comment .shares');if(!$article.length&&!$shareBox.length)return;if($shareBox.data('total')){$shareBox.find('span').text($shareBox.data('total'));}
else{var total=0;var url=window.location.href;if(stButtons.countsResp.hasOwnProperty(url)){total=stButtons.countsResp[url].total;}
$shareBox.find('span').text(total);$shareBox.data('total',total);}};self.setupLoadArticles=function(){var $button=$('.load-articles button'),$holder=$('.loaded-holder');$button.on('click',function(e){$.ajax({url:$button.data('next'),dataType:'json',beforeSend:function(){$button.addClass('loading').prop('disabled',true);},complete:function(){$button.removeClass('loading').prop('disabled',false);},success:function(resp){var html='';for(var i=0;i<resp.objects.length;i++){html+=resp.objects[i].html;}
$holder.append(html);$button.data('next',resp.meta.next).toggle(resp.meta.next!==null);setTimeout(function(){$(window).resize();},1000);}});});};self.setupPlaylist=function(){var $form=$('.shuffle-form');var $platform=$form.find('select[name=platform]');var $playtime=$form.find('select[name=playtime]');var $button=$('.load-articles button');var $holder=$('.loaded-holder');$('.shuffle-form select').selectBoxIt({showFirstOption:false}).change(function(){$form.removeClass('shuffling');$(this).parent().submit();});$form.find('button').on('click',function(e){$form.addClass('shuffling');});$form.on('submit',function(e){e.preventDefault();var data={platform:$platform.val(),playtime:$playtime.val()};if(!$form.hasClass('shuffling')){data.order_by='-id';}
$.getJSON($form.prop('action'),data).success(function(resp){var html='';for(var i=0;i<resp.objects.length;i++){html+=resp.objects[i].html;}
$holder.html(html);var nextURL=resp.meta.next;if($form.hasClass('shuffling'))nextURL=nextURL.replace(/&?order_by=-?id/g,'');$button.data('next',nextURL).toggle(resp.meta.next!==null);setTimeout(function(){$(window).resize();},1000);});});$('.playlist-blocks').on('click','.article-block a',function(e){e.preventDefault();self.loadPlaylistArticle($(this).data('id'));});if(window.location.hash){self.loadPlaylistArticle(window.location.hash.replace('#',''));}};self.loadPlaylistArticle=function(id){var $preview=$('.playlist-sidebar .playlist-article-preview');$.ajax({url:'/playlist/detail/'+id,dataType:'json',success:function(resp){$preview.html(resp.html);$html.toggleClass('sidebar-opened');$overlay.trigger('overlay.update');updateHash(id);}});};var updateHash=function(val){if(history.pushState){history.pushState(null,null,'#'+val);}
else{window.location.hash=val;}}
return self;})(window.jQuery);$(function(){KS.init();});$(window).on('load',function(){var dotEls=['.home .recent-articles .content','.article-preview'];$.each(dotEls,function(index,el){var $el=$(el);if($el.length)$el.dotdotdot({watch:'window'});});$(this).resize();KS.positionHomeLargeAd();KS.positionSidebar();setTimeout(KS.updateShareCount,1500);(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(d.getElementById(id))return;js=d.createElement(s);js.id=id;js.src="//connect.facebook.net/en_US/all.js#xfbml=1&appId=335125073201055";fjs.parentNode.insertBefore(js,fjs);}(document,'script','facebook-jssdk'));$(function(){$("a[href^='http']").attr('rel','external');$("a[rel=external]").click(function(){window.open(this.href,'_blank');return false;});})
(function(){var elem=document.createElement('script');elem.src=(document.location.protocol=="https:"?"https://secure":"http://edge")+".quantserve.com/quant.js";elem.async=true;elem.type="text/javascript";var scpt=document.getElementsByTagName('script')[0];scpt.parentNode.insertBefore(elem,scpt);})();_qevents.push({qacct:"p-2cxKrXmiCj_Vo"});});